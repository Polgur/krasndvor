{% extends "base.html" %}
{% load staticfiles %}
{% load core_tags %}
{% load thumbnail %}

{% block content %}
  <ol class="breadcrumbs">
    <li><a href="\">Главная</a></li>
    <li><a href="{% url 'project_list' %}?tech={{ techfilter.pk }}&search=1&vid=0&pmin=0&pmax=5000000&smin=0&smax=500">Проекты</a>
    </li>
    {% if techfilter.pk == 2 %}
      <li><a
              href="{% url 'project_list' %}?tech={{ techfilter.pk }}&search=1&vid=0&pmin=0&pmax=5000000&smin=0&smax=500">Проекты
        из СИП панелей</a></li>
    {% elif techfilter.pk == 3 %}
      <li><a
              href="{% url 'project_list' %}?tech={{ techfilter.pk }}&search=1&vid=0&pmin=0&pmax=5000000&smin=0&smax=500">Проекты
        по каркасной технологии</a></li>
    {% else %}
      <li><a
              href="{% url 'project_list' %}?tech={{ techfilter.pk }}&search=1&vid=0&pmin=0&pmax=5000000&smin=0&smax=500">Проекты
        из Термопанелей</a></li>
    {% endif %}
    <li class="active">{{ project.name|title }}</li>
  </ol>

  <div class="katalog tovar clearfix">
    <div class="kat-title">
      {{ project.name|title }}
    </div>

    <div class="tovar-header clearfix">
      <a class="gallery tovar-foto" href="{{ project.img.url }}">
        {% thumbnail project.img "508x382" format="PNG" as im %}
          <img class="img-responsive" src="{{ im.url }}" alt="{{ project.name|title }}">
        {% endthumbnail %}
      </a>
      <div class="tovar-charact clearfix">
        <div class="name">{{ project.name|title }}</div>
        <span class="title">Характеристики проекта:</span>
        <span>{{ project.description|linebreaks }}</span>
      </div>
    </div>

    <div class="kat-title">
      фасады
    </div>
    <div class="tovar-fasad clearfix">
      {% for ph in project.photos.all %}
        {% if ph.type == 1 %}
          <div class="col-md-3 col-xs-6">
            <a class="gallery" href="{{ ph.img.url }}">
              {% thumbnail ph.img "196x110" format="PNG" as im %}
                <img src="{{ im.url }}" alt="">
              {% endthumbnail %}
            </a>
          </div>
        {% endif %}
      {% endfor %}

    </div>
    <div class="kat-title">
      Планировка
    </div>
    <div class="plan clearfix">
      {% for ph in project.photos.all %}
        {% if ph.type > 1 %}
          <div class="col-md-6 col-xs-12">
            <a class="gallery" href="{{ ph.img.url }}">
              {% thumbnail ph.img "393" crop="center" format="PNG" as im %}
                <img class="img-responsive" src="{{ im.url }}" alt="">
              {% endthumbnail %}
            </a>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="tovar-compl">
      <div class="item active">
        <span class="title">Комплектация "Комфорт"</span>
        <div class="compl-wrap" style="display: block;">
          <div>
            {{ kit.kit1|safe }}
          </div>
          <div class="price-and-button clearfix">
            <div class="text">
              <span>Цена проекта {{ project.name|title }} (комплектация "Комфорт)"</span>
              <span class="price">{{ kit.price1|intspace }} <span>&#8381;</span></span>
            </div>
            <button type="button" class="button" data-toggle="modal" data-target="#prjcalc" data-calc="1">
              <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Заказать
            </button>
          </div>
        </div>
      </div>
      <div class="item">
        <span class="title">Комплектация "Престиж"</span>
        <div class="compl-wrap">
          <div>
            {{ kit.kit2|safe }}
          </div>
          <div class="price-and-button clearfix">
            <div class="text">
              <span>Цена проекта {{ project.name|title }} (комплектация "Престиж)"</span>
              <span class="price">{{ kit.price2|intspace }} <span>&#8381;</span></span>
            </div>
            <button type="button" class="button" data-toggle="modal" data-target="#prjcalc" data-calc="2">
              <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Заказать
            </button>
          </div>
        </div>
      </div>
      <div class="item">
        <span class="title">Комплектация "Премиум"</span>
        <div class="compl-wrap">
          <div>
            {{ kit.kit3|safe }}
          </div>
          <div class="price-and-button clearfix">
            <div class="text">
              <span>Цена проекта {{ project.name|title }} (комплектация "Премиум)"</span>
              <span class="price">{{ kit.price3|intspace }} <span>&#8381;</span></span>
            </div>
            <button type="button" class="button" data-toggle="modal" data-target="#prjcalc" data-calc="2">
              <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span> Заказать
            </button>
          </div>
        </div>
      </div>
    </div><!-- /.tovar-compl -->

    <div class="content-page clearfix">
      <h2>Цены на проект <b>{{ project.name }}</b> по другим технологиям:</h2>
      <table class="table table-hover comp-kit">
        <tr>
          <th>Технология</th>
          <th>Комфорт</th>
          <th>Престиж</th>
          <th>Премиум</th>
          <th></th>
        </tr>
        {% for ckit in compkit %}
          <tr>
            <td class="tech-title">{{ ckit.tech.mnemo|upper }}</td>
            <td class="comp-price"><b>{{ ckit.price1|intspace }}</b> ₽</td>
            <td class="comp-price"><b>{{ ckit.price2|intspace }}</b> ₽</td>
            <td class="comp-price"><b>{{ ckit.price3|intspace }}</b> ₽</td>
            <td class="comp-link"><a href="{% url 'project_detail' project.slug %}?tech={{ ckit.tech.pk }}">
              Посмотреть
            </a></td>
          </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <div class="modal" id="prjcalc">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Заказать проект <b>{{ project.name|title }}</b> <span class="badge"
                                                                                        style="background-color: #468847;">{{ techfilter.mnemo }}</span>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </h3>
        </div>
        <div class="modal-body">
          {% get_prjc_form as calc_form %}
          <form id="prjcalc_form" action="{% url 'thanks_prj' %}" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="{{ calc_form.fio.name }}" class="fieldWrapper form-group">
              <label for="{{ calc_form.fio.id_for_label }}">{{ calc_form.fio.label }}:</label>
              {{ calc_form.fio }}
            </div>
            <div id="{{ calc_form.email.name }}" class="fieldWrapper form-group">
              <label for="{{ calc_form.email.id_for_label }}">{{ calc_form.email.label }}:</label>
              {{ calc_form.email }}
            </div>
            <div id="{{ calc_form.phone.name }}" class="fieldWrapper form-group">
              <label for="{{ calc_form.phone.id_for_label }}">{{ calc_form.phone.label }}:</label>
              {{ calc_form.phone }}
            </div>
            <div id="{{ calc_form.note.name }}" class="fieldWrapper form-group">
              <label for="{{ calc_form.note.id_for_label }}">{{ calc_form.note.label }}:</label>
              {{ calc_form.note }}
            </div>
            <div id="{{ calc_form.file.name }}" class="fieldWrapper form-group">
              <label for="{{ calc_form.file.id_for_label }}">{{ calc_form.file.label }}:</label>
              {{ calc_form.file }}
            </div>
            <input type="hidden" name="{{ calc_form.kit.name }}" id="{{ calc_form.kit.id_for_label }}"
                   value="{{ kit.pk }}">
            <input type="hidden" name="{{ calc_form.kit_numb.name }}" id="{{ calc_form.kit_numb.id_for_label }}">

            <button type="submit" class="btn btn-primary">Заказать</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
      $('#prjcalc').on('show.bs.modal', function (event) {
          var button = $(event.relatedTarget) // Button that triggered the modal
          var calc_num = button.data('calc') // Extract info from data-* attributes
          // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
          // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
          var modal = $(this)
          modal.find('.modal-body input[name="{{ calc_form.kit_numb.name }}"]').val(calc_num)
      })
  </script>

  <script>
      $(".tovar-compl .title").click(function () {
          $(this).parent().toggleClass("active").siblings().removeClass('active');
          $(this).parent().siblings().children("div").hide();
          $(this).next().slideToggle();
      });
      var max_item_height = 0; // максимальная высота, первоначально 0
      $(".tovar-compl .compl-wrap").each(function () {
          if ($(this).height() > max_item_height) { // если высота колонки больше значения максимальной высоты,
              max_item_height = $(this).height(); // то она сама становится новой максимальной высотой
          }
      });
      $(".tovar-compl").height(max_item_height + 100); // устанавливаем высоту каждой колонки равной значению максимальной высоты
  </script>

  <script>
      $(document).ready(function () {
          $("form#prjcalc_form").submit(function () {
              var formData = new FormData($(this)[0]);
              $('.form-err').detach();
              $.ajax({
                  url: $(this).attr('action'),
                  type: 'POST',
                  data: formData,
                  async: true,
                  success: function (data) {
                      if (data.status === 1) {
                          $('#prjcalc').modal('hide');
                          $('#prjcalc [name="fio"]').val('');
                          $('#prjcalc [name="email"]').val('');
                          $('#prjcalc [name="phone"]').val('');
                          $('#prjcalc [name="note"]').val('');
                          window.location = "{% url 'thanks_prj' %}"
                      }
                      else {
                          $.each(data.errors, function (index, value) {
                              $('#' + index + '').append("<span class='form-err text-danger'>" + value[0] + "</span>");
                          });
                      }
                  },
                  contentType: false,
                  processData: false
              });

              return false;
          });
      });
  </script>
{% endblock %}

